<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ãƒˆ7 äºˆæƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }
        /* ãƒ­ãƒˆã®ãƒœãƒ¼ãƒ«é¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .loto-ball {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.25rem;
            color: white;
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), 2px 2px 4px rgba(0,0,0,0.1);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .ball-mini {
            width: 28px; height: 28px; font-size: 0.8rem;
        }
        /* ç•ªå·å¸¯ã”ã¨ã®è‰²åˆ†ã‘ */
        .ball-yellow { background: linear-gradient(135deg, #fbbf24, #d97706); color: #000; text-shadow: none; }
        .ball-blue { background: linear-gradient(135deg, #60a5fa, #2563eb); }
        .ball-red { background: linear-gradient(135deg, #f87171, #dc2626); }
        .ball-green { background: linear-gradient(135deg, #34d399, #059669); }
        
        /* å‡¦ç†ä¸­ã®ã‚¹ãƒ”ãƒŠãƒ¼ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden relative">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="relative bg-gradient-to-r from-slate-800 to-indigo-900 p-6 text-white text-center">
            <h1 class="text-3xl font-black mb-2 tracking-wider mt-2">ğŸ¯ ãƒ­ãƒˆ7 äºˆæƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro</h1>
            <p class="text-sm opacity-90 text-indigo-200">ãƒãƒ«ã‚³ãƒ•æ¨ç§»ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ ï¼† ç”Ÿå­˜æ™‚é–“(å€‹åˆ¥ãƒãƒã‚Šåˆ†å¸ƒ)åˆ†æAIæ­è¼‰</p>
        </div>

        <div class="p-6 md:p-8 space-y-8">
            
            <!-- STEP 1: ãƒ‡ãƒ¼ã‚¿æº–å‚™ -->
            <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                <h2 class="text-xl font-bold border-b-2 border-indigo-500 pb-2 mb-2 text-slate-800">STEP 1: éå»ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™</h2>
                <p class="text-xs text-slate-500 mb-4 bg-white p-2 border border-slate-200 rounded">
                    ğŸ’¡ åŒéšå±¤ã«ã‚ã‚‹ <code>Data.txt</code> ã‚’è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br>
                    ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ç›´æ¥ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ã€Œãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
                </p>
                <textarea id="csvData" rows="6" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-xs font-mono mb-2 bg-white shadow-inner" placeholder="Data.txt ã‚’èª­ã¿è¾¼ã¿ä¸­...&#10;ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥è²¼ã‚Šä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚"></textarea>
                
                <div class="mb-4">
                    <label class="inline-flex items-center text-sm text-slate-700 cursor-pointer">
                        <input type="checkbox" id="includeBonus" class="rounded text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-2">ãƒœãƒ¼ãƒŠã‚¹æ•°å­—ã‚‚å…¨ä½“å‡ºç¾é »åº¦ã®é›†è¨ˆã«å«ã‚ã‚‹</span>
                    </label>
                </div>

                <div class="mb-4 bg-white p-3 border border-indigo-200 rounded-lg shadow-sm">
                    <span class="block text-sm font-bold text-slate-700 mb-2">è§£æãƒ¢ãƒ¼ãƒ‰é¸æŠ:</span>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-slate-50 px-3 py-2 rounded border hover:bg-slate-100 transition">
                            <input type="radio" name="analyzeMode" value="predict" checked class="text-indigo-600 focus:ring-indigo-500 w-4 h-4">
                            <span class="text-sm text-slate-800"><b>é€šå¸¸äºˆæƒ³</b> <span class="text-xs text-slate-500">ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦æ¬¡å›ã®äºˆæƒ³ã‚’ã™ã‚‹ï¼‰</span></span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-indigo-50 px-3 py-2 rounded border border-indigo-200 hover:bg-indigo-100 transition">
                            <input type="radio" name="analyzeMode" value="backtest" class="text-indigo-600 focus:ring-indigo-500 w-4 h-4">
                            <span class="text-sm font-bold text-indigo-700">éå»æ¤œè¨¼ï¼ˆãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼‰ <span class="text-xs text-indigo-500 font-normal">ï¼ˆä¸€ç•ªä¸‹ã®è¡Œã‚’æ­£è§£ã¨ã—ã¦éš ã—ã€ãƒ†ã‚¹ãƒˆã™ã‚‹ï¼‰</span></span>
                        </label>
                    </div>
                </div>

                <div class="mt-3 flex flex-wrap gap-4">
                    <button id="btnMockData" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded transition text-sm">
                        ğŸ§ª ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                    </button>
                    <button id="btnAnalyze" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition flex items-center gap-2 w-full md:w-auto justify-center">
                        <span class="text-lg">ğŸ“Š ãƒ‡ãƒ¼ã‚¿è§£æã¨AIæœ€é©åŒ–ã‚’å®Ÿè¡Œ</span>
                    </button>
                </div>
            </section>

            <!-- STEP 2: åˆ†æçµæœ -->
            <section id="analysisSection" class="hidden">
                <h2 id="analysisTitle" class="text-xl font-bold border-b-2 border-indigo-500 pb-2 mb-4 text-slate-800">STEP 2: ãƒ‡ãƒ¼ã‚¿è§£æçµæœ ï¼† AIå­¦ç¿’ãƒ¢ãƒ‡ãƒ«</h2>
                
                <!-- ç›´è¿‘ã®å½“ã›ã‚“æ•°å­— -->
                <div class="bg-white p-4 rounded-lg border border-slate-200 mb-6 flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <div>
                        <h3 class="font-bold text-slate-800 mb-1">ğŸ“Œ ç›´è¿‘ï¼ˆæœ€æ–°å›ï¼‰ã®å½“ã›ã‚“æ•°å­—</h3>
                        <p class="text-xs text-slate-500">ã“ã®çµæœã‚’èµ·ç‚¹ã¨ã—ã€ãƒãƒ«ã‚³ãƒ•é€£é–ã«ã‚ˆã‚‹æ¨ç§»ç¢ºç‡ã¨æ³¢åŠåŠ¹æœã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
                    </div>
                    <div id="latestDraw" class="flex gap-1 font-bold text-lg"></div>
                </div>

                <!-- ãƒã‚¯ãƒ­ãƒ»ãƒŸã‚¯ãƒ­åˆ†æUI -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- ç›¸æ€§ãƒšã‚¢ -->
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-200 shadow-sm">
                        <h3 class="font-bold text-purple-800 mb-2 border-b border-purple-200 pb-1 text-sm">ğŸ’ æœ€å¼·ã®ç›¸æ€§ãƒšã‚¢ (åŒæ™‚å‡ºç¾)</h3>
                        <p class="text-[10px] text-purple-600 mb-2">åŒã˜å›ã«ä¸€ç·’ã«é¸ã°ã‚ŒãŸå›æ•° Top5</p>
                        <ul id="bestPairs" class="space-y-2 text-sm text-purple-900 font-mono"></ul>
                    </div>

                    <!-- é·ç§»ç¢ºç‡ -->
                    <div class="bg-amber-50 p-4 rounded-xl border border-amber-200 shadow-sm relative">
                        <div class="absolute -top-3 -right-3 bg-amber-500 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow">New</div>
                        <h3 class="font-bold text-amber-800 mb-2 border-b border-amber-200 pb-1 text-sm">â¡ï¸ å‰å›ã‹ã‚‰ã®ã€Œæµã‚Œã€ (æ¨ç§»ç¢ºç‡)</h3>
                        <p class="text-[10px] text-amber-600 mb-2">å‰å›ã®æ•°å­—ã®<b>ã€Œç›´å¾Œã€</b>ã«å‡ºãŸå›æ•° Top5</p>
                        <ul id="bestTransitions" class="space-y-2 text-sm text-amber-900 font-mono"></ul>
                    </div>

                    <!-- ã‚¹ãƒ©ãƒ³ãƒ—ãƒ»æœ€å¤§ãƒãƒã‚Š -->
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 shadow-sm">
                        <h3 class="font-bold text-blue-800 mb-2 border-b border-blue-200 pb-1 text-sm">â„ï¸ ã‚¹ãƒ©ãƒ³ãƒ—é™ç•Œæ•°å­— (ç”Ÿå­˜æ™‚é–“åˆ†æ)</h3>
                        <p class="text-[10px] text-blue-600 mb-2">ç¾åœ¨ã®ãƒãƒã‚Šå›æ•°ã¨ã€éå»æœ€å¤§ãƒãƒã‚Šå›æ•°</p>
                        <ul id="coldNumbers" class="space-y-2 text-sm"></ul>
                    </div>
                </div>

                <!-- AIè‡ªå·±å­¦ç¿’çµæœ -->
                <div class="bg-slate-800 p-5 rounded-xl shadow-lg text-sm text-slate-200 mb-6">
                    <h3 class="font-bold text-indigo-300 mb-2 border-b border-slate-600 pb-2 flex items-center gap-2">
                        ğŸ¤– Fisheråˆ¤åˆ¥æ¯”ã«åŸºã¥ãAIè‡ªå‹•é‡ã¿ä»˜ã‘ï¼ˆãƒšãƒŠãƒ«ãƒ†ã‚£æœ€é©åŒ–ï¼‰
                    </h3>
                    <p class="text-xs text-slate-400 mb-4">ã€Œæ­£è§£ãƒ‡ãƒ¼ã‚¿ã€ã¨ã€Œãƒ©ãƒ³ãƒ€ãƒ ãªãƒã‚ºãƒ¬ã€ã®åˆ†å¸ƒå·®ï¼ˆFisherã®åˆ¤åˆ¥æ¯”ï¼‰ã‚’è¨ˆç®—ã—ã€ãƒã‚ºãƒ¬ã‚’æœ€ã‚‚é«˜ç²¾åº¦ã«å¼¾ãå‡ºã›ã‚‹ç‰¹å¾´é‡ã«é‡ã¿ã‚’è‡ªå‹•åˆ†é…ã—ã¾ã—ãŸã€‚</p>
                    <div id="aiWeightsDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3">
                        <!-- JSã§ãƒãƒ¼ã‚’æŒ¿å…¥ -->
                    </div>
                </div>

                <!-- ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒ -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm text-sm text-slate-700 hidden" id="histScoreSection">
                    <h3 class="font-bold text-slate-800 mb-2 border-b pb-2">ğŸ“Š åŸºç¤ã‚¹ã‚³ã‚¢ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¾ãƒ¼ãƒ³åˆ†æï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæŠ½å‡ºï¼‰</h3>
                    <p class="text-xs text-slate-500 mb-4">å„å›ã®æŠ½ã›ã‚“æ™‚ç‚¹ã§ã€Œãã‚Œã‚ˆã‚Šå‰ã®ãƒ‡ãƒ¼ã‚¿ã€ã‚’ä½¿ã£ã¦å­¦ç¿’ã—ã€æ­£è§£çµæœãŒä½•ç‚¹ã®åŸºç¤ã‚¹ã‚³ã‚¢ã ã£ãŸã‹ã®å®Ÿç¸¾ã§ã™ã€‚<br><span class="text-indigo-600 font-bold">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«ã¯ã€ã“ã®ã€Œå¹³å‡åŸºç¤ã‚¹ã‚³ã‚¢ã€ã«æœ€ã‚‚è¿‘ã„é©åº¦ãªæ³¢å½¢ãŒã€æœ€çµ‚ã‚¹ã‚³ã‚¢10,000ç‚¹ï¼ˆå°¤åº¦æœ€å¤§ï¼‰ã¨ãªã‚‹ã‚ˆã†è‡ªå·±è£œæ­£ã—ã¾ã™ã€‚</span></p>
                    <div class="flex flex-col md:flex-row gap-8 items-center">
                        <div class="w-full md:w-2/3">
                            <div id="scoreDistribution" class="space-y-2">
                                <!-- JSã§æŒ¿å…¥ -->
                            </div>
                        </div>
                        <div class="w-full md:w-1/3 bg-slate-50 p-4 rounded-lg border border-slate-200 text-center">
                            <span class="text-slate-500 font-bold text-xs block mb-1">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåŸºç¤ã‚¹ã‚³ã‚¢ (å¹³å‡)</span> 
                            <b id="avgHistScore" class="text-4xl text-indigo-600 font-black tracking-tighter"></b>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STEP 3: ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <section id="simulationSection" class="hidden bg-slate-800 text-white p-6 rounded-xl shadow-2xl relative overflow-hidden mt-8">
                <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10 pointer-events-none"></div>
                <h2 class="text-xl font-bold border-b border-slate-600 pb-2 mb-6 text-indigo-300">STEP 3: ç¢ºç‡éç¨‹æœ€é©åŒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                
                <div class="flex flex-col gap-5 mb-6 relative z-10">
                    <div class="flex flex-col md:flex-row md:items-start gap-4">
                        <label class="font-bold text-slate-300 shrink-0 mt-2">è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰:</label>
                        <div class="flex flex-col gap-3 bg-slate-900/50 p-4 rounded-lg w-full border border-slate-700">
                            <label class="flex items-start gap-2 cursor-pointer group">
                                <input type="radio" name="simMode" value="count" checked class="mt-1 text-indigo-500 focus:ring-indigo-500 w-4 h-4">
                                <span class="text-sm group-hover:text-white transition">å›æ•°æŒ‡å®šãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•<br><span class="text-xs text-slate-400">ï¼ˆæŒ‡å®šã—ãŸå›æ•°ã ã‘ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã—ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¾ãƒ¼ãƒ³ã«è¿‘ã„ã‚‚ã®ã‚’æŠ½å‡ºï¼‰</span></span>
                            </label>
                            <label class="flex items-start gap-2 cursor-pointer group pt-2 border-t border-slate-700/50">
                                <input type="radio" name="simMode" value="all" class="mt-1 text-indigo-500 focus:ring-indigo-500 w-4 h-4">
                                <span class="text-sm text-indigo-300 font-bold group-hover:text-indigo-200 transition">å…¨1,029ä¸‡ãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨ç·å½“ãŸã‚Šè§£æ (æ¿€é¸æ¨å¥¨)<br><span class="text-[10px] text-slate-400">ï¼ˆå…¨é€šã‚Šã‚’è¨ˆç®—ã—ã€AIãŒç‰¹å®šã—ãŸç¾å®Ÿã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¾ãƒ¼ãƒ³ã«æœ€ã‚‚è¿‘ã„æ³¢ã‚’æŠ½å‡ºã€‚æ•°ç§’ã€œæ•°åç§’ã‹ã‹ã‚Šã¾ã™ï¼‰</span></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-6 p-4 bg-slate-900/30 rounded-lg border border-slate-700">
                        <div id="countModeUI" class="flex items-center gap-2">
                            <label class="font-bold text-slate-300 text-sm shrink-0">è©¦è¡Œå›æ•°:</label>
                            <select id="simCount" class="p-2 border border-slate-600 rounded bg-slate-800 text-white text-sm outline-none focus:border-indigo-500">
                                <option value="10000">10,000å›</option>
                                <option value="50000" selected>50,000å›</option>
                                <option value="100000">100,000å›</option>
                                <option value="300000">300,000å›</option>
                            </select>
                        </div>
                        
                        <div id="allModeUI" class="flex items-center gap-2 hidden">
                            <span class="text-indigo-300 text-xs font-bold bg-indigo-900/50 px-3 py-1 rounded border border-indigo-700/50">â€»ãƒ–ãƒ©ã‚¦ã‚¶ã®æ€§èƒ½ã«ã‚ˆã‚Šå‡¦ç†æ™‚é–“ãŒç•°ãªã‚Šã¾ã™</span>
                        </div>

                        <div class="flex items-center gap-2 mt-2 md:mt-0">
                            <label class="font-bold text-slate-300 text-sm shrink-0">äºˆæƒ³æŠ½å‡ºæ•°:</label>
                            <select id="ticketCount" class="p-2 border border-slate-600 rounded bg-slate-800 text-white text-sm outline-none focus:border-indigo-500">
                                <option value="3">3é€šã‚Š</option>
                                <option value="5" selected>5é€šã‚Š</option>
                                <option value="10">10é€šã‚Š</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button id="btnSimulate" class="w-full relative overflow-hidden bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-black py-4 px-4 rounded-xl shadow-[0_0_15px_rgba(79,70,229,0.5)] transition flex justify-center items-center gap-2 text-lg z-10 group">
                    <span class="relative z-10">ğŸ° æœ€æ–°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§äºˆæƒ³ã‚’ç”Ÿæˆã™ã‚‹</span>
                    <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity"></div>
                </button>
            </section>

            <!-- çµæœè¡¨ç¤º -->
            <section id="resultSection" class="hidden mt-12">
                <h2 class="text-2xl font-black text-center text-slate-800 mb-8 tracking-wide">âœ¨ AIæœ€é©åŒ– äºˆæƒ³çµæœ âœ¨</h2>
                <div id="predictionResults" class="space-y-6">
                    <!-- JSã§çµæœã‚’æŒ¿å…¥ -->
                </div>
            </section>

        </div>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ç”¨ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let totalDraws = 0;
        let testTargetDraw = null;
        let testTargetBonus = [];

        // çµ±è¨ˆãƒ¢ãƒ‡ãƒ«å…¨ä½“ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let statsData = {
            lastDraw: [],        
            nFreq: Array(38).fill(0),
            coMatrix: [], 
            transitionMatrix: [],
            momentumMap: [], 
            decadeProb: {}, 
            intervals: Array(38).fill(0),
            maxIntervals: Array(38).fill(0),
            intervalHistory: Array.from({length: 38}, () => []),
            exp: {
                sum: { mean: 130, std: 25 },
                odd: { mean: 3.5, std: 1.2 },
                consec: { mean: 0.8, std: 0.8 },
                pull: { mean: 1.2, std: 1.0 },
                intSum: { mean: 40, std: 15 },
                intStd: { mean: 8, std: 4 },
                coScore: { mean: 20, std: 5 },
                transScore: { mean: 10, std: 3 },
                indvIntZ: { mean: 0, std: 1 },
                momentum: { mean: 0, std: 1 },
                adjPull: { mean: 1.5, std: 1.0 }, 
                decade: { mean: 0.05, std: 0.02 },
                block: { mean: 4.5, std: 0.8 } 
            },
            // AIæœ€é©åŒ–ã•ã‚Œã‚‹é‡ã¿
            weights: { sum: 100, odd: 100, consec: 100, pull: 100, int: 100, intStd: 100, coScore: 100, trans: 100, indvInt: 100, momentum: 100, adj: 100, dec: 100, block: 100 },
            histMean: 8500,
            histStd: 500
        };

        const elements = {
            csvData: document.getElementById('csvData'),
            includeBonus: document.getElementById('includeBonus'),
            btnMockData: document.getElementById('btnMockData'),
            btnAnalyze: document.getElementById('btnAnalyze'),
            analysisSection: document.getElementById('analysisSection'),
            analysisTitle: document.getElementById('analysisTitle'),
            latestDraw: document.getElementById('latestDraw'),
            simulationSection: document.getElementById('simulationSection'),
            bestPairs: document.getElementById('bestPairs'),
            bestTransitions: document.getElementById('bestTransitions'),
            coldNumbers: document.getElementById('coldNumbers'),
            aiWeightsDisplay: document.getElementById('aiWeightsDisplay'),
            histScoreSection: document.getElementById('histScoreSection'),
            scoreDistribution: document.getElementById('scoreDistribution'),
            avgHistScore: document.getElementById('avgHistScore'),
            modeRadios: document.querySelectorAll('input[name="simMode"]'),
            countModeUI: document.getElementById('countModeUI'),
            allModeUI: document.getElementById('allModeUI'),
            simCount: document.getElementById('simCount'),
            ticketCount: document.getElementById('ticketCount'),
            btnSimulate: document.getElementById('btnSimulate'),
            resultSection: document.getElementById('resultSection'),
            predictionResults: document.getElementById('predictionResults')
        };

        // --- åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
        fetch('Data.txt')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Data.txt ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
                return response.text();
            })
            .then(data => {
                elements.csvData.value = data;
                elements.csvData.placeholder = "ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚";
            })
            .catch(error => {
                console.log('åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ:', error);
                elements.csvData.value = '';
                elements.csvData.placeholder = "Data.txt ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ã€Œãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚";
            });

        // UIã‚¤ãƒ™ãƒ³ãƒˆ
        elements.modeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                elements.countModeUI.classList.add('hidden');
                elements.allModeUI.classList.add('hidden');
                if (e.target.value === 'count') elements.countModeUI.classList.remove('hidden');
                else if (e.target.value === 'all') elements.allModeUI.classList.remove('hidden');
            });
        });

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function getBallColorClass(num) {
            if (num >= 1 && num <= 9) return 'ball-yellow';
            if (num >= 10 && num <= 19) return 'ball-blue';
            if (num >= 20 && num <= 29) return 'ball-red';
            if (num >= 30 && num <= 37) return 'ball-green';
            return 'bg-slate-500';
        }

        function countConsecutives(nums) {
            let count = 0;
            for(let i = 0; i < nums.length - 1; i++) if(nums[i+1] - nums[i] === 1) count++;
            return count;
        }

        function getDecadeKey(nums) {
            let d = [0,0,0,0];
            nums.forEach(n => d[Math.floor(n/10)]++);
            return d.join(':');
        }

        function countAdjacent(nums, refNums) {
            if (!refNums || refNums.length === 0) return 0;
            let count = 0;
            nums.forEach(n => { if (refNums.includes(n - 1) || refNums.includes(n + 1)) count++; });
            return count;
        }

        function getBlockCover(nums) {
            let blocks = new Set();
            nums.forEach(n => blocks.add(Math.ceil(n / 7.4))); // ç´„5ãƒ–ãƒ­ãƒƒã‚¯
            return blocks.size;
        }

        function generateRandom7() {
            let available = Array.from({length: 37}, (_, i) => i + 1);
            let picked = [];
            for(let i = 0; i < 7; i++) {
                let r = Math.floor(Math.random() * available.length);
                picked.push(available[r]);
                available.splice(r, 1);
            }
            return picked.sort((a, b) => a - b);
        }

        elements.btnMockData.addEventListener('click', () => {
            let csv = [];
            for (let i = 1; i <= 300; i++) {
                let mainDraw = generateRandom7();
                let available = Array.from({length: 37}, (_, i) => i + 1).filter(n => !mainDraw.includes(n));
                let bonusDraw = [available[Math.floor(Math.random()*available.length)], available[Math.floor(Math.random()*available.length)]];
                csv.push(`ç¬¬${i}å›,${mainDraw.join(',')},${bonusDraw.join(',')}`);
            }
            elements.csvData.value = csv.join('\n');
            alert('300å›åˆ†ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚');
        });

        function parseLoto7Line(line) {
            let tokens = line.split(/[\s,]+/);
            let nums = tokens.filter(t => /^\d+$/.test(t)).map(n => parseInt(n, 10)).filter(n => n >= 1 && n <= 37);
            if (nums.length >= 7) {
                let mainNums = nums.slice(0, 7);
                let isSorted = true;
                for(let i=0; i<6; i++) { if(mainNums[i] >= mainNums[i+1]) isSorted = false; }
                if(isSorted) return nums; 
                return [...mainNums.sort((a, b) => a - b), ...nums.slice(7)];
            }
            return null;
        }

        // --- Huberæå¤±ãƒ©ã‚¤ã‚¯ãªãƒšãƒŠãƒ«ãƒ†ã‚£é–¢æ•° ---
        function getPenalty(z, weight) {
            if (z <= 1.0) return 0; 
            if (z <= 2.0) return (z - 1.0) * weight * 0.5; 
            return (1.0 * weight * 0.5) + Math.pow(z - 2.0, 2) * weight; 
        }

        // --- ç‰¹å¾´é‡æŠ½å‡ºé–¢æ•° ---
        function extractFeatures(draw, model) {
            let sum = 0, oddCount = 0, pullCount = 0, consecCount = 0;
            let intervals = [], momentumSum = 0, coScore = 0, transScore = 0, indvIntZSum = 0;

            for (let i = 0; i < 7; i++) {
                let n = draw[i];
                sum += n;
                if (n % 2 !== 0) oddCount++;
                if (model.lastDraw && model.lastDraw.includes(n)) pullCount++;
                if (i < 6 && draw[i+1] - n === 1) consecCount++;
                
                intervals.push(model.intervals ? model.intervals[n] : 0);
                momentumSum += model.momentumMap ? model.momentumMap[n] : 0;
                
                if (model.coMatrix) {
                    for (let j = i + 1; j < 7; j++) coScore += model.coMatrix[n][draw[j]];
                }

                // ç”Ÿå­˜æ™‚é–“åˆ†æ
                let currentInt = model.intervals ? model.intervals[n] : 0;
                let hist = model.intervalHistory ? model.intervalHistory[n] : [];
                if (hist && hist.length > 0) {
                    let mean = hist.reduce((a,b)=>a+b,0) / hist.length;
                    let std = Math.sqrt(hist.reduce((a,b)=>a+Math.pow(b-mean,2),0) / hist.length) || 1;
                    indvIntZSum += Math.abs(currentInt - mean) / std;
                }
            }

            // ãƒãƒ«ã‚³ãƒ•é·ç§»
            if (model.lastDraw && model.transitionMatrix) {
                model.lastDraw.forEach(prevNum => {
                    draw.forEach(currNum => { transScore += model.transitionMatrix[prevNum][currNum]; });
                });
            }
            
            let intSum = intervals.reduce((a,b)=>a+b, 0);
            let intMean = intSum / 7;
            let intStd = Math.sqrt(intervals.reduce((a,b)=>a+Math.pow(b-intMean,2), 0)/7);
            let adjCount = countAdjacent(draw, model.lastDraw);
            let decKey = getDecadeKey(draw);
            let p_dec = model.decadeProb ? (model.decadeProb[decKey] || 0) : 0;
            let blockCover = getBlockCover(draw);

            // Zã‚¹ã‚³ã‚¢åŒ–
            let e = model.exp;
            let z = (val, mean, std, minStd=0.5) => Math.abs(val - mean) / Math.max(std, minStd);

            return { 
                sum: z(sum, e.sum.mean, e.sum.std, 1.0), 
                odd: z(oddCount, e.odd.mean, e.odd.std), 
                consec: z(consecCount, e.consec.mean, e.consec.std), 
                pull: z(pullCount, e.pull.mean, e.pull.std), 
                int: z(intSum, e.intSum.mean, e.intSum.std, 1.0), 
                intStd: z(intStd, e.intStd.mean, e.intStd.std), 
                coScore: z(coScore, e.coScore.mean, e.coScore.std, 1.0), 
                trans: z(transScore, e.transScore.mean, e.transScore.std, 1.0),
                indvInt: z(indvIntZSum, e.indvIntZ.mean, e.indvIntZ.std, 0.5),
                momentum: z(momentumSum, e.momentum.mean, e.momentum.std), 
                adj: z(adjCount, e.adjPull.mean, e.adjPull.std), 
                dec: z(p_dec, e.decade.mean, e.decade.std, 0.01), 
                block: z(blockCover, (e.block || e.blockCover).mean, (e.block || e.blockCover).std),
                raw: { sum, oddCount, pullCount, consecCount, intSum, transScore }
            };
        }

        // åŸºç¤ã‚¹ã‚³ã‚¢è¨ˆç®—
        function calcRawScore(draw, model, weights) {
            let f = extractFeatures(draw, model);
            let score = 10000;
            for(let k of Object.keys(weights)) score -= getPenalty(f[k], weights[k]);
            return { score: score, ...f.raw };
        }

        // --- AIé‡ã¿ä»˜ã‘ï¼ˆFisheråˆ¤åˆ¥æ¯”ï¼‰ ---
        function trainWeights(validLines, tempModel) {
            let dummyData = [];
            for(let i=0; i<1500; i++) dummyData.push(generateRandom7());

            let targetLines = validLines.slice(-200).map(line => line.slice(0,7).sort((a,b)=>a-b));
            let keys = ['sum', 'odd', 'consec', 'pull', 'int', 'intStd', 'coScore', 'trans', 'indvInt', 'momentum', 'adj', 'dec', 'block'];
            
            let tFeats = {}; let dFeats = {};
            keys.forEach(k => { tFeats[k] = []; dFeats[k] = []; });

            targetLines.forEach(d => {
                let f = extractFeatures(d, tempModel);
                keys.forEach(k => tFeats[k].push(getPenalty(f[k], 1))); 
            });
            dummyData.forEach(d => {
                let f = extractFeatures(d, tempModel);
                keys.forEach(k => dFeats[k].push(getPenalty(f[k], 1)));
            });

            let scores = {}; let totalScore = 0;
            
            keys.forEach(k => {
                let tMean = tFeats[k].reduce((a,b)=>a+b,0) / tFeats[k].length;
                let dMean = dFeats[k].reduce((a,b)=>a+b,0) / dFeats[k].length;
                let tVar = tFeats[k].reduce((a,b)=>a+Math.pow(b-tMean,2),0) / tFeats[k].length;
                let dVar = dFeats[k].reduce((a,b)=>a+Math.pow(b-dMean,2),0) / dFeats[k].length;
                
                let diff = Math.max(0.001, dMean - tMean); 
                let denom = Math.sqrt(tVar + dVar) || 1;
                
                scores[k] = Math.log1p(diff / denom);
                totalScore += scores[k];
            });

            let bestWeights = {};
            keys.forEach(k => {
                let ratio = totalScore > 0 ? (scores[k] / totalScore) : (1/keys.length);
                bestWeights[k] = 30 + (ratio * 1500); // é‡ã¿ã‚¹ã‚±ãƒ¼ãƒ«
            });
            return bestWeights;
        }

        // --- çµ±è¨ˆãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰é–¢æ•° ---
        function calculateStatsModel(lines, includeBonus) {
            let nFreq = Array(38).fill(0);
            let freqShort = Array(38).fill(0), freqMid = Array(38).fill(0);
            let tDraws = 0;
            
            let coMatrix = Array.from({length: 38}, () => Array(38).fill(0));
            let transitionMatrix = Array.from({length: 38}, () => Array(38).fill(0));
            let decadeCounts = {};
            
            let fLists = { sums:[], odds:[], consecs:[], pulls:[], intSums:[], intStds:[], coScores:[], transScores:[], indvIntZs:[], momentums:[], decProbs:[], adjPulls:[], blockCovers:[] };
            
            let tempIntervals = Array(38).fill(0); 
            let maxIntervals = Array(38).fill(0);
            let intervalHistory = Array.from({length: 38}, () => []);
            let pDraw = null;

            let wShort = Math.min(5, lines.length), wMid = Math.min(15, lines.length);
            lines.slice(-wShort).forEach(nums => nums.slice(0, 7).forEach(n => freqShort[n]++));
            lines.slice(-wMid).forEach(nums => nums.slice(0, 7).forEach(n => freqMid[n]++));
            
            // å…¨ä½“é »åº¦ãƒ»å…±èµ·ãƒãƒˆãƒªã‚¯ã‚¹ã®æ§‹ç¯‰
            lines.forEach(nums => {
                let mainNums = nums.slice(0, 7);
                let targetNums = includeBonus ? nums : mainNums;
                targetNums.forEach(n => { if(n<=37) nFreq[n]++; });
                
                for(let i=0; i<mainNums.length; i++) {
                    for(let j=i+1; j<mainNums.length; j++) {
                        coMatrix[mainNums[i]][mainNums[j]]++;
                        coMatrix[mainNums[j]][mainNums[i]]++;
                    }
                }
                decadeCounts[getDecadeKey(mainNums)] = (decadeCounts[getDecadeKey(mainNums)] || 0) + 1;
                tDraws++;
            });
            
            let decadeProb = {};
            for(let k in decadeCounts) decadeProb[k] = decadeCounts[k] / tDraws;

            // ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ãƒãƒƒãƒ—
            let momentumMap = Array(38).fill(0);
            for(let i=1; i<=37; i++) {
                let pShort = freqShort[i] / wShort, pMid = freqMid[i] / wMid, pAll = nFreq[i] / tDraws;
                momentumMap[i] = (pShort - pMid) * 1.5 + (pMid - pAll);
            }

            // æ™‚ç³»åˆ—ã«æ²¿ã£ãŸç‰¹å¾´é‡ã®å±¥æ­´æŠ½å‡º
            lines.forEach(nums => {
                let mainNums = nums.slice(0, 7);
                
                fLists.sums.push(mainNums.reduce((a,b)=>a+b, 0));
                fLists.odds.push(mainNums.filter(n => n%2 !== 0).length);
                fLists.consecs.push(countConsecutives(mainNums));
                fLists.blockCovers.push(getBlockCover(mainNums));
                fLists.decProbs.push(decadeProb[getDecadeKey(mainNums)] || 0);
                
                if (pDraw !== null) {
                    fLists.pulls.push(mainNums.filter(n => pDraw.includes(n)).length);
                    fLists.adjPulls.push(countAdjacent(mainNums, pDraw));
                    pDraw.forEach(pn => mainNums.forEach(cn => transitionMatrix[pn][cn]++));
                    
                    let tScore = 0;
                    pDraw.forEach(pn => mainNums.forEach(cn => tScore += transitionMatrix[pn][cn]));
                    fLists.transScores.push(tScore);
                }
                
                let invs = mainNums.map(n => tempIntervals[n]);
                let iSum = invs.reduce((a,b)=>a+b,0);
                fLists.intSums.push(iSum);
                let iMean = iSum/7;
                fLists.intStds.push(Math.sqrt(invs.reduce((a,b)=>a+Math.pow(b-iMean,2),0)/7));
                
                let iZSum = 0;
                mainNums.forEach(n => {
                    let hist = intervalHistory[n];
                    if (hist.length > 0) {
                        let m = hist.reduce((a,b)=>a+b,0)/hist.length;
                        let s = Math.sqrt(hist.reduce((a,b)=>a+Math.pow(b-m,2),0)/hist.length) || 1;
                        iZSum += Math.abs(tempIntervals[n] - m) / s;
                    }
                });
                fLists.indvIntZs.push(iZSum);

                let cScore = 0;
                for(let i=0; i<mainNums.length; i++) {
                    for(let j=i+1; j<mainNums.length; j++) cScore += coMatrix[mainNums[i]][mainNums[j]];
                }
                fLists.coScores.push(cScore);
                fLists.momentums.push(mainNums.reduce((acc, n) => acc + momentumMap[n], 0));
                
                for(let i=1; i<=37; i++) {
                    if (mainNums.includes(i)) {
                        intervalHistory[i].push(tempIntervals[i]);
                        if (tempIntervals[i] > maxIntervals[i]) maxIntervals[i] = tempIntervals[i];
                        tempIntervals[i] = 0;
                    } else {
                        tempIntervals[i]++;
                    }
                }
                pDraw = mainNums;
            });

            const calcMean = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
            const calcStd = (arr, mean) => arr.length ? Math.sqrt(arr.reduce((a,b)=>a+Math.pow(b-mean,2),0)/arr.length) || 0 : 0;

            let exp = {};
            for(let key in fLists) {
                let mean = calcMean(fLists[key]);
                exp[key.replace(/s$/, '')] = { mean: mean, std: calcStd(fLists[key], mean) };
            }
            exp.intSum = exp.intSum || exp.int; exp.intStd = exp.intStd || exp.int; exp.adjPull = exp.adjPull || exp.adj;
            exp.decade = exp.decProb || exp.dec; exp.transScore = exp.transScore || exp.tran; exp.indvIntZ = exp.indvIntZ || exp.indvInt;
            exp.block = exp.blockCover || exp.block;

            return { nFreq, tDraws, lastDraw: pDraw, coMatrix, transitionMatrix, momentumMap, decadeProb, intervals: tempIntervals, maxIntervals, intervalHistory, exp };
        }

        // --- ãƒ¡ã‚¤ãƒ³å‡¦ç†é–‹å§‹ ---
        elements.btnAnalyze.addEventListener('click', () => {
            const rawData = elements.csvData.value.trim();
            const includeBonus = elements.includeBonus.checked;
            
            if (!rawData) { alert('ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }

            elements.btnAnalyze.disabled = true;
            elements.btnAnalyze.innerHTML = `<div class="loader border-white border-top-transparent w-4 h-4 border-2"></div> <span>AIè§£æä¸­...</span>`;

            setTimeout(() => {
                let validLines = [];
                rawData.split('\n').forEach(line => {
                    let nums = parseLoto7Line(line);
                    if (nums && nums.length >= 7) validLines.push(nums);
                });

                if (validLines.length < 5) { alert('ãƒ‡ãƒ¼ã‚¿ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚'); elements.btnAnalyze.disabled = false; return; }

                const mode = document.querySelector('input[name="analyzeMode"]:checked').value;
                testTargetDraw = null; testTargetBonus = [];
                if (mode === 'backtest') {
                    let testData = validLines.pop(); 
                    testTargetDraw = testData.slice(0, 7).sort((a,b)=>a-b);
                    if (testData.length > 7) testTargetBonus = testData.slice(7);
                }

                let finalModel = calculateStatsModel(validLines, includeBonus);
                let optWeights = trainWeights(validLines, finalModel);
                finalModel.weights = optWeights;

                // ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¾ãƒ¼ãƒ³ã®åˆ†å¸ƒã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
                let histScores = []; let tScore = 0;
                if (validLines.length > 20) {
                    for (let i = 20; i < validLines.length; i++) {
                        let tempModel = calculateStatsModel(validLines.slice(0, i), includeBonus);
                        let eval = calcRawScore(validLines[i].slice(0,7).sort((a,b)=>a-b), tempModel, optWeights);
                        histScores.push({ index: i, score: eval.score });
                        tScore += eval.score;
                    }
                }
                
                finalModel.histMean = histScores.length ? tScore / histScores.length : 8500;
                finalModel.histStd = histScores.length ? Math.max(Math.sqrt(histScores.reduce((a,b)=>a+Math.pow(b.score-finalModel.histMean,2),0)/histScores.length), 100) : 500;
                
                statsData = finalModel;

                displayAnalysis();
                displayHistScores(histScores);

                elements.analysisSection.classList.remove('hidden');
                elements.simulationSection.classList.remove('hidden');
                elements.resultSection.classList.add('hidden');

                elements.btnAnalyze.disabled = false;
                elements.btnAnalyze.innerHTML = `<span>ğŸ“Š ãƒ‡ãƒ¼ã‚¿è§£æã¨AIæœ€é©åŒ–ã‚’å®Ÿè¡Œ</span>`;
            }, 50); 
        });

        // --- UIè¡¨ç¤ºé–¢æ•° ---
        function displayAnalysis() {
            elements.analysisTitle.innerHTML = `STEP 2: ãƒ‡ãƒ¼ã‚¿è§£æçµæœ ï¼† AIå­¦ç¿’ãƒ¢ãƒ‡ãƒ«` + (testTargetDraw ? ` <span class="text-sm text-white bg-indigo-500 px-2 py-1 rounded ml-2">ğŸ” éå»æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰</span>` : ``);
            
            elements.latestDraw.innerHTML = '';
            statsData.lastDraw.forEach(n => elements.latestDraw.innerHTML += `<div class="ball-mini rounded-full flex items-center justify-center text-white shadow ${getBallColorClass(n)}">${n}</div>`);

            // ç›¸æ€§ãƒšã‚¢
            let pairs = [];
            for(let i=1; i<=37; i++) for(let j=i+1; j<=37; j++) if(statsData.coMatrix[i] && statsData.coMatrix[i][j]>0) pairs.push({p1:i, p2:j, c:statsData.coMatrix[i][j]});
            elements.bestPairs.innerHTML = pairs.sort((a,b)=>b.c-a.c).slice(0,5).map(p => `
                <li class="flex justify-between items-center bg-white p-2 rounded border border-purple-100">
                    <span class="flex gap-1"><span class="bg-purple-100 text-purple-800 px-1 rounded">${p.p1}</span> & <span class="bg-purple-100 text-purple-800 px-1 rounded">${p.p2}</span></span>
                    <span class="font-bold text-purple-700">${p.c}å›</span>
                </li>
            `).join('');

            // ãƒãƒ«ã‚³ãƒ•é·ç§»
            let trans = [];
            if (statsData.lastDraw && statsData.transitionMatrix) {
                statsData.lastDraw.forEach(pn => {
                    for(let i=1; i<=37; i++) if(statsData.transitionMatrix[pn][i]>0) trans.push({pn:pn, cn:i, c:statsData.transitionMatrix[pn][i]});
                });
            }
            let nextNumScores = Array(38).fill(0);
            trans.forEach(t => nextNumScores[t.cn] += t.c);
            let topNext = [];
            for(let i=1; i<=37; i++) if(nextNumScores[i]>0) topNext.push({num:i, score:nextNumScores[i]});
            
            elements.bestTransitions.innerHTML = topNext.sort((a,b)=>b.score-a.score).slice(0,5).map(n => `
                <li class="flex justify-between items-center bg-white p-2 rounded border border-amber-100">
                    <span class="font-bold flex items-center gap-2">â” <div class="ball-mini rounded-full flex items-center justify-center text-white ${getBallColorClass(n.num)}">${n.num}</div></span>
                    <span class="text-amber-700 text-xs">é·ç§»æ³¢åŠ: ${n.score}Pt</span>
                </li>
            `).join('');

            // ã‚¹ãƒ©ãƒ³ãƒ—ãƒ»ç”Ÿå­˜æ™‚é–“
            let intervals = [];
            for (let i = 1; i <= 37; i++) intervals.push({ num: i, int: statsData.intervals[i], max: statsData.maxIntervals[i] });
            elements.coldNumbers.innerHTML = intervals.sort((a,b)=>b.int-a.int).slice(0,5).map(i => {
                let ratio = Math.min(100, (i.int / i.max) * 100);
                let isDanger = ratio >= 90;
                return `
                <li class="bg-white p-2 rounded border border-blue-100">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-slate-700">${i.num}</span>
                        <span class="text-xs ${isDanger?'text-red-500 font-bold':'text-blue-600'}">${i.int}å› ãƒãƒã‚Š</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5 flex overflow-hidden">
                        <div class="${isDanger?'bg-red-500':'bg-blue-400'}" style="width: ${ratio}%"></div>
                    </div>
                    <div class="text-[9px] text-right text-slate-400 mt-0.5">éå»æœ€å¤§: ${i.max}å›</div>
                </li>
            `}).join('');

            // AIé‡ã¿è¡¨ç¤º
            let map = [
                { k: 'trans', n: 'ãƒãƒ«ã‚³ãƒ•é·ç§»(æµã‚Œ)é‡è¦åº¦' }, { k: 'indvInt', n: 'å€‹åˆ¥å‘¨æœŸ(ç”Ÿå­˜é™ç•Œ)é‡è¦åº¦' }, { k: 'coScore', n: 'ç›¸é–¢ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é‡è¦åº¦' },
                { k: 'intStd', n: 'æ··ã–ã‚Šå…·åˆ(åˆ†æ•£)é‡è¦åº¦' }, { k: 'momentum', n: 'ãƒˆãƒ¬ãƒ³ãƒ‰å‹¢ã„é‡è¦åº¦' }, { k: 'adj', n: 'éš£æ¥æ³¢åŠé‡è¦åº¦' },
                { k: 'dec', n: 'ç•ªå°ã‚°ãƒ«ãƒ¼ãƒ—åã‚ŠãƒšãƒŠãƒ«ãƒ†ã‚£' }, { k: 'block', n: 'åŒºç”»åˆ†æ•£ãƒšãƒŠãƒ«ãƒ†ã‚£' }, { k: 'consec', n: 'é€£ç•ªæ•°ç•°å¸¸ãƒšãƒŠãƒ«ãƒ†ã‚£' },
                { k: 'sum', n: 'åˆè¨ˆå€¤ç•°å¸¸ãƒšãƒŠãƒ«ãƒ†ã‚£' }, { k: 'odd', n: 'å¥‡æ•°å¶æ•°æ¯”ãƒšãƒŠãƒ«ãƒ†ã‚£' }, { k: 'pull', n: 'å¼•ã£å¼µã‚Šç•°å¸¸ãƒšãƒŠãƒ«ãƒ†ã‚£' }, { k: 'int', n: 'ç·ãƒãƒã‚Šç•°å¸¸ãƒšãƒŠãƒ«ãƒ†ã‚£' }
            ].sort((a,b) => statsData.weights[b.k] - statsData.weights[a.k]);

            let totalW = Object.values(statsData.weights).reduce((a,b)=>a+b,0);
            elements.aiWeightsDisplay.innerHTML = map.map((m, i) => {
                let p = ((statsData.weights[m.k]/totalW)*100).toFixed(1);
                let isTop = i < 3;
                return `
                    <div class="mb-2">
                        <div class="flex justify-between text-[10px] mb-1 ${isTop?'text-indigo-300 font-bold':'text-slate-500'}">
                            <span>${m.n} ${i===0?'ğŸ‘‘':''}</span><span>${p}%</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1"><div class="${isTop?'bg-indigo-400':'bg-slate-600'} h-1 rounded-full" style="width:${p}%"></div></div>
                    </div>
                `}).join('');
        }

        function displayHistScores(scores) {
            if(!scores.length) { elements.histScoreSection.classList.add('hidden'); return; }
            elements.histScoreSection.classList.remove('hidden');
            elements.avgHistScore.textContent = Math.round(statsData.histMean);
            
            let dist = [{l:'9500ç‚¹~',min:9500,c:0,col:'bg-red-400'},{l:'9000~9499',min:9000,c:0,col:'bg-amber-400'},{l:'8500~8999',min:8500,c:0,col:'bg-green-400'},{l:'~8499',min:-9999,c:0,col:'bg-blue-400'}];
            scores.forEach(s => { for(let i=0; i<dist.length; i++) if(s.score >= dist[i].min) { dist[i].c++; break; } });
            
            let maxC = Math.max(...dist.map(d=>d.c));
            elements.scoreDistribution.innerHTML = dist.map(d => `
                <div class="flex items-center text-xs gap-2">
                    <div class="w-16 text-slate-600 font-bold text-right">${d.l}</div>
                    <div class="flex-1 bg-slate-100 h-4 rounded overflow-hidden"><div class="${d.col} h-full" style="width:${(d.c/maxC)*100}%"></div></div>
                    <div class="w-8 text-slate-500 text-right">${d.c}</div>
                </div>
            `).join('');
        }

        // --- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡é–¢æ•° ---
        function evaluateDraw(draw) {
            let base = calcRawScore(draw, statsData, statsData.weights);
            let diff = Math.abs(base.score - statsData.histMean);
            let zDiff = diff / Math.max(statsData.histStd, 50);
            let finalScore = 10000 - (zDiff * 250); 
            return { score: finalScore, rawScore: base.score, sum: base.sum, oddCount: base.oddCount, pullCount: base.pullCount, consecCount: base.consecCount, transScore: base.transScore };
        }

        elements.btnSimulate.addEventListener('click', () => {
            const mode = document.querySelector('input[name="simMode"]:checked').value;
            const tCount = parseInt(elements.ticketCount.value);
            
            elements.btnSimulate.disabled = true;
            elements.btnSimulate.innerHTML = `<div class="loader border-white border-top-transparent"></div> <span class="relative z-10">AIæ¼”ç®—ä¸­...</span>`;
            elements.resultSection.classList.add('hidden');

            setTimeout(() => {
                if (mode === 'count') runCountMode(parseInt(elements.simCount.value), tCount);
                else runAllMode(tCount);
            }, 50);
        });

        function runCountMode(iters, tCount) {
            let res = [];
            for (let i = 0; i < iters; i++) {
                let d = generateRandom7();
                res.push({ d: d, e: evaluateDraw(d) });
            }
            processResults(res.sort((a,b)=>b.e.score - a.e.score), tCount, iters, "ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•");
        }

        function runAllMode(tCount) {
            const TOTAL = 10295472;
            let processed = 0, topRes = [], minScore = -Infinity, combo = [1,2,3,4,5,6,7], isDone = false;

            function chunk() {
                let cCount = 0;
                while (cCount < 30000 && !isDone) {
                    let d = [...combo], e = evaluateDraw(d);
                    if (e.score > minScore) {
                        topRes.push({d:d, e:e}); topRes.sort((a,b)=>b.e.score - a.e.score);
                        if (topRes.length > tCount*5) topRes.pop();
                        if (topRes.length === tCount*5) minScore = topRes[topRes.length-1].e.score;
                    }
                    let i = 6;
                    while (i >= 0 && combo[i] === 37 - 6 + i) i--;
                    if (i < 0) isDone = true;
                    else { combo[i]++; for (let j=i+1; j<7; j++) combo[j] = combo[j-1]+1; }
                    cCount++; processed++;
                }

                if (isDone) processResults(topRes, tCount, TOTAL, "å®Œå…¨ç·å½“ãŸã‚Šè§£æ");
                else {
                    elements.btnSimulate.innerHTML = `<div class="loader border-white border-top-transparent"></div> <div class="flex flex-col items-center"><span class="text-sm font-bold relative z-10">å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³è§£æä¸­... ${((processed/TOTAL)*100).toFixed(1)}%</span></div>`;
                    setTimeout(chunk, 0);
                }
            }
            chunk();
        }

        function processResults(results, tCount, iters, modeName) {
            let unique = [], seen = new Set();
            for (let r of results) {
                let k = r.d.join(',');
                if (!seen.has(k)) { seen.add(k); unique.push(r); if(unique.length >= tCount*2) break; }
            }
            
            let preds = [unique[0]]; 
            let cands = unique.slice(1);
            for (let i=cands.length-1; i>0; i--) { let j=Math.floor(Math.random()*(i+1)); [cands[i],cands[j]] = [cands[j],cands[i]]; }
            for (let i=0; i<tCount-1 && i<cands.length; i++) preds.push(cands[i]);

            renderResults(preds, iters, modeName);
            
            elements.btnSimulate.disabled = false;
            elements.btnSimulate.innerHTML = `<span class="relative z-10">ğŸ° æœ€æ–°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§äºˆæƒ³ã‚’ç”Ÿæˆã™ã‚‹</span>`;
            elements.resultSection.classList.remove('hidden');
            elements.resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function renderResults(preds, iters, modeName) {
            let html = `
                <div class="text-center text-sm text-slate-700 mb-6 bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <b class="text-indigo-600 text-lg block mb-2">${modeName} å®Œäº†</b>
                    è¨ˆç®—ç©ºé–“ <b>${iters.toLocaleString()} é€šã‚Š</b> ã‚’è©•ä¾¡ã—ã€<br>
                    ã€Œãƒãƒ«ã‚³ãƒ•é·ç§»ç¢ºç‡ã€ã¨ã€Œé©åº¦ãªãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒã€ã«æœ€ã‚‚åˆè‡´ã—ãŸ <b>${preds.length} ãƒ‘ã‚¿ãƒ¼ãƒ³</b>ã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚
                </div>
            `;

            if (testTargetDraw) {
                let te = evaluateDraw(testTargetDraw);
                html += `
                    <div class="mb-6 p-4 bg-slate-800 text-white rounded-xl shadow-lg border border-slate-700">
                        <b class="text-indigo-300 block mb-2 text-sm">ğŸ¯ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆéå»æ¤œè¨¼ï¼‰ç­”ãˆåˆã‚ã›</b>
                        <p class="text-xs text-slate-400 mb-3">éš ã—ã¦ãŠã„ãŸã€Œæœ€æ–°å›ã®æ­£è§£ã€ã§ã™ã€‚ä»¥ä¸‹ã®äºˆæƒ³ã¨æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚</p>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-bold text-slate-400 w-12">æœ¬æ•°å­—:</span>
                            ${testTargetDraw.map(n => `<div class="ball-mini rounded-full flex items-center justify-center font-bold ${getBallColorClass(n)}">${n}</div>`).join('')}
                        </div>
                        <div class="text-xs text-slate-300 bg-slate-900 inline-block px-3 py-1.5 rounded border border-slate-700">
                            ã“ã®æ­£è§£ã®æœ€é©åŒ–ã‚¹ã‚³ã‚¢: <span class="text-indigo-400 font-bold text-base">${Math.round(te.score)}</span> ç‚¹
                        </div>
                    </div>
                `;
            }

            preds.forEach((p, i) => {
                let mCount = 0, bMatch = 0;
                if (testTargetDraw) {
                    p.d.forEach(n => { if (testTargetDraw.includes(n)) mCount++; else if (testTargetBonus.includes(n)) bMatch++; });
                }

                html += `
                    <div class="bg-white p-5 rounded-xl shadow-md border ${i===0?'border-indigo-400 ring-2 ring-indigo-100':'border-slate-200'} relative overflow-hidden">
                        ${i===0?'<div class="absolute top-0 left-0 bg-indigo-500 text-white text-[10px] font-bold px-3 py-1 rounded-br-lg shadow">AI æœ¬å‘½æ¨å¥¨</div>':''}
                        
                        <div class="flex justify-between items-center border-b border-slate-100 pb-3 mb-4 mt-2">
                            <span class="font-black text-slate-700 text-lg tracking-widest">äºˆæƒ³ ${i + 1}</span>
                            <div class="text-right">
                                <div class="text-[10px] text-slate-400">ç·åˆå°¤åº¦ã‚¹ã‚³ã‚¢</div>
                                <div class="text-xl font-black ${p.e.score>=9000?'text-red-500':'text-indigo-600'}">${Math.round(p.e.score)}</div>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 md:gap-3 justify-center mb-5">
                            ${p.d.map(n => `<div class="loto-ball ${getBallColorClass(n)}">${n}</div>`).join('')}
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div class="flex flex-col"><span class="text-slate-400">ãƒãƒ«ã‚³ãƒ•æ¨ç§»æ³¢åŠ</span><b class="text-amber-600">${p.e.transScore} Pt</b></div>
                            <div class="flex flex-col"><span class="text-slate-400">å‰å›ã‹ã‚‰ã®å¼•ã£å¼µã‚Š</span><b class="${p.e.pullCount>0?'text-blue-600':''}">${p.e.pullCount} å€‹</b></div>
                            <div class="flex flex-col"><span class="text-slate-400">å¥‡å¶æ¯” (å¥‡:å¶)</span><b>${p.e.oddCount}:${7-p.e.oddCount}</b></div>
                            <div class="flex flex-col"><span class="text-slate-400">åˆè¨ˆå€¤</span><b>${p.e.sum}</b></div>
                        </div>
                `;

                if (testTargetDraw) {
                    let pText = "ãƒã‚ºãƒ¬", bgClass = "bg-slate-50 text-slate-500 border-slate-200";
                    if(mCount===7){pText="ğŸ‘‘ 1ç­‰ç›¸å½“ï¼";bgClass="bg-red-100 text-red-700 border-red-300 font-bold";}
                    else if(mCount===6&&bMatch>=1){pText="âœ¨ 2ç­‰ç›¸å½“ï¼";bgClass="bg-orange-100 text-orange-700 border-orange-300 font-bold";}
                    else if(mCount===6){pText="ğŸ‰ 3ç­‰ç›¸å½“ï¼";bgClass="bg-orange-50 text-orange-700 border-orange-200 font-bold";}
                    else if(mCount===5){pText="ğŸ‘ 4ç­‰ç›¸å½“";bgClass="bg-blue-50 text-blue-700 border-blue-200 font-bold";}
                    else if(mCount===4){pText="ğŸ‘ 5ç­‰ç›¸å½“";bgClass="bg-green-50 text-green-700 border-green-200 font-bold";}
                    else if(mCount===3&&bMatch>=1){pText="â˜ºï¸ 6ç­‰ç›¸å½“";bgClass="bg-indigo-50 text-indigo-700 border-indigo-200 font-bold";}
                    
                    html += `<div class="mt-4 p-3 text-center text-sm border rounded-lg ${bgClass}">çµæœ: æœ¬æ•°å­— <b>${mCount}</b> å€‹ä¸€è‡´${bMatch>0?` (B <b>${bMatch}</b> å€‹)`:''} â” <span class="text-base ml-2">${pText}</span></div>`;
                }
                html += `</div>`;
            });
            elements.predictionResults.innerHTML = html;
        }
    </script>
</body>
</html>
