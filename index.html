<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ãƒˆ7 äºˆæƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }
        /* ãƒ­ãƒˆã®ãƒœãƒ¼ãƒ«é¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .loto-ball {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.25rem;
            color: white;
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), 2px 2px 4px rgba(0,0,0,0.1);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        /* ç•ªå·å¸¯ã”ã¨ã®è‰²åˆ†ã‘ */
        .ball-yellow { background: linear-gradient(135deg, #fbbf24, #d97706); color: #000; text-shadow: none; }
        .ball-blue { background: linear-gradient(135deg, #60a5fa, #2563eb); }
        .ball-red { background: linear-gradient(135deg, #f87171, #dc2626); }
        .ball-green { background: linear-gradient(135deg, #34d399, #059669); }
        
        /* å‡¦ç†ä¸­ã®ã‚¹ãƒ”ãƒŠãƒ¼ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-700 p-6 text-white text-center">
            <h1 class="text-3xl font-black mb-2 tracking-wider">ğŸ¯ ãƒ­ãƒˆ7 äºˆæƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p class="text-sm opacity-90">ãƒãƒ«ã‚³ãƒ•é€£é–æ¨ç§» ï¼† å®Œå…¨ä¹±æ•°å°¤åº¦è©•ä¾¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </p>
        </div>

        <div class="p-6 md:p-8 space-y-8">
            
            <!-- STEP 1: ãƒ‡ãƒ¼ã‚¿æº–å‚™ -->
            <section class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h2 class="text-xl font-bold border-b-2 border-indigo-500 pb-2 mb-4">STEP 1: éå»ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™</h2>
                <p class="text-sm text-gray-600 mb-4">
                    éå»ã®å½“ã›ã‚“ç•ªå·ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
                    <span class="text-indigo-600 font-bold">ï¼ˆâ€»ä¸€ç•ªä¸‹ã®è¡ŒãŒã€Œæœ€æ–°å›ã€ã¨ã—ã¦èªè­˜ã•ã‚Œã€ç›´è¿‘ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚„å¼•ã£å¼µã‚Šæ•°å­—ã®è¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼‰</span>
                </p>
                <textarea id="csvData" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm font-mono mb-2" placeholder="ã“ã“ã«è¡¨ãƒ‡ãƒ¼ã‚¿ã‚„ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...&#10;&#10;ä¾‹ï¼š&#10;ç¬¬641å› 1 3 7 23 24 33 36 17 30 J 5ï¼š2 127 6ï¼š3 174 è©³ç´°è¡¨ç¤º&#10;ç¬¬642å› 1 7 22 23 33 34 35 2 24 E 5ï¼š2 155 5ï¼š4 181 è©³ç´°è¡¨ç¤º"></textarea>
                <div class="mb-4">
                    <label class="inline-flex items-center text-sm text-gray-700 cursor-pointer">
                        <input type="checkbox" id="includeBonus" class="rounded text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-2">ãƒœãƒ¼ãƒŠã‚¹æ•°å­—ã‚‚å…¨ä½“å‡ºç¾é »åº¦ã®é›†è¨ˆã«å«ã‚ã‚‹</span>
                    </label>
                </div>
                <div class="mt-3 flex gap-4">
                    <button id="btnMockData" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition">
                        ğŸ§ª ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                    </button>
                    <button id="btnAnalyze" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow transition">
                        ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ç›´è¿‘ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å­¦ç¿’
                    </button>
                </div>
            </section>

            <!-- STEP 2: åˆ†æçµæœ -->
            <section id="analysisSection" class="hidden">
                <h2 class="text-xl font-bold border-b-2 border-blue-500 pb-2 mb-4">STEP 2: çµ±è¨ˆè§£æãƒ»ç›´è¿‘ãƒˆãƒ¬ãƒ³ãƒ‰å­¦ç¿’çµæœ</h2>
                
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div>
                        <h3 class="font-bold text-indigo-800 mb-1">ğŸ“Œ ç›´è¿‘ï¼ˆæœ€æ–°å›ï¼‰ã®å½“ã›ã‚“æ•°å­—</h3>
                        <p class="text-sm text-indigo-600">ã“ã®æ•°å­—ã‹ã‚‰ã®ã€Œå¼•ã£å¼µã‚Šã€ã‚„ã€Œå¥‡å¶æ¯”ã®æºã‚Šæˆ»ã—ã€ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
                    </div>
                    <div id="latestDraw" class="flex gap-1 font-bold text-lg"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                        <h3 class="font-bold text-red-700 mb-2">ğŸ”¥ å…¨æœŸé–“ Hot Numbers</h3>
                        <ul id="hotNumbers" class="space-y-1 text-sm"></ul>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h3 class="font-bold text-blue-700 mb-2">â„ï¸ å…¨æœŸé–“ Cold Numbers</h3>
                        <ul id="coldNumbers" class="space-y-1 text-sm"></ul>
                    </div>
                </div>

                <!-- ç›´è¿‘ã®ãƒˆãƒ¬ãƒ³ãƒ‰ -->
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300 mb-6 shadow-sm">
                    <h3 class="font-bold text-yellow-800 mb-2 border-b border-yellow-200 pb-1">ğŸ“ˆ ç›´è¿‘ã®æµã‚Œ (ã“ã“10å›ã®ãƒˆãƒ¬ãƒ³ãƒ‰)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-2">
                        <div>
                            <span class="text-gray-600 block mb-1">æœ€è¿‘ã‚ˆãå‡ºã¦ã„ã‚‹æ•°å­—:</span>
                            <div id="recentHot" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <span class="text-gray-600 block mb-1">æœ€è¿‘ã®å¹³å‡åˆè¨ˆå€¤:</span>
                            <b id="recentSum" class="text-xl text-yellow-700"></b> <span class="text-xs text-gray-500">(å…¨æœŸé–“å¹³å‡: <span id="allTimeSum"></span>)</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm text-sm text-gray-700">
                    <h3 class="font-bold text-gray-800 mb-3 border-b pb-1">ğŸ“Š ãƒ­ãƒˆ7ã®çµ±è¨ˆçš„ç‰¹å¾´ï¼ˆå°¤åº¦è©•ä¾¡åŸºæº–ï¼‰</h3>
                    <ul id="statisticalFeatures" class="grid grid-cols-1 md:grid-cols-3 gap-y-4 gap-x-6">
                        <!-- JSã§æŒ¿å…¥ -->
                    </ul>
                </div>
            </section>

            <!-- STEP 3: ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <section id="simulationSection" class="hidden bg-gray-800 text-white p-6 rounded-xl border border-gray-700 shadow-inner">
                <h2 class="text-xl font-bold border-b-2 border-gray-500 pb-2 mb-4 text-yellow-400">STEP 3: æœ¬æ ¼ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                
                <div class="flex flex-col gap-5 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <label class="font-bold text-gray-200 shrink-0">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å¼:</label>
                        <div class="flex flex-col md:flex-row gap-4 bg-gray-900 p-3 rounded-lg w-full">
                            <label class="flex items-start gap-2 cursor-pointer group">
                                <input type="radio" name="simMode" value="count" checked class="mt-1 text-yellow-500 focus:ring-yellow-500 w-4 h-4">
                                <span class="text-sm group-hover:text-yellow-200 transition">å›æ•°æŒ‡å®šãƒ¢ãƒ¼ãƒ‰<br><span class="text-xs text-gray-400">ï¼ˆæŒ‡å®šã—ãŸå›æ•°ã ã‘å›ã—ã€ãã®ä¸­ã®ä¸Šä½ã‚’æŠ½å‡ºï¼‰</span></span>
                            </label>
                            <label class="flex items-start gap-2 cursor-pointer group">
                                <input type="radio" name="simMode" value="all" class="mt-1 text-yellow-500 focus:ring-yellow-500 w-4 h-4">
                                <span class="text-sm text-yellow-300 font-bold group-hover:text-yellow-100 transition">å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨è§£æãƒ¢ãƒ¼ãƒ‰ (æ¿€é¸)<br><span class="text-xs text-yellow-600/70">ï¼ˆå…¨10,295,472é€šã‚Šã‚’ç·å½“ãŸã‚Šè¨ˆç®—ã—ã€æœ€å¼·ã®è²·ã„ç›®ã‚’æŠ½å‡ºï¼‰</span></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-6 p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                        <!-- å›æ•°æŒ‡å®šç”¨UI -->
                        <div id="countModeUI" class="flex items-center gap-2">
                            <label class="font-bold text-gray-200 text-sm shrink-0">ä»®æƒ³æŠ½é¸å›æ•°:</label>
                            <select id="simCount" class="p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                                <option value="10000">10,000å›</option>
                                <option value="50000" selected>50,000å›</option>
                                <option value="100000">100,000å›</option>
                            </select>
                        </div>
                        
                        <!-- å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³æŒ‡å®šç”¨UI -->
                        <div id="allModeUI" class="flex items-center gap-2 hidden">
                            <span class="text-yellow-400 text-sm font-bold">â€»å…¨10,295,472ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è§£æã™ã‚‹ãŸã‚ã€å®Œäº†ã¾ã§æ•°ç§’ã€œåæ•°ç§’ã‹ã‹ã‚Šã¾ã™ã€‚</span>
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="font-bold text-gray-200 text-sm shrink-0">äºˆæƒ³æŠ½å‡ºå£æ•°:</label>
                            <select id="ticketCount" class="p-2 border border-gray-600 rounded bg-gray-700 text-white text-sm">
                                <option value="1">1å£</option>
                                <option value="2">2å£</option>
                                <option value="3">3å£</option>
                                <option value="4">4å£</option>
                                <option value="5" selected>5å£</option>
                                <option value="6">6å£</option>
                                <option value="7">7å£</option>
                                <option value="8">8å£</option>
                                <option value="9">9å£</option>
                                <option value="10">10å£</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button id="btnSimulate" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-gray-900 font-black py-4 px-4 rounded-lg shadow-lg transition flex justify-center items-center gap-2 text-lg">
                    <span>ğŸ° å®Œå…¨ä¹±æ•°ç”Ÿæˆï¼†å°¤åº¦è©•ä¾¡ã‚’é–‹å§‹ã™ã‚‹</span>
                </button>
            </section>

            <!-- çµæœè¡¨ç¤º -->
            <section id="resultSection" class="hidden">
                <h2 class="text-2xl font-black text-center text-gray-800 mb-6 border-b-4 border-indigo-500 inline-block pb-2">âœ¨ çµ±è¨ˆé©åˆåº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°äºˆæƒ³ âœ¨</h2>
                <div id="predictionResults" class="space-y-4">
                    <!-- JSã§çµæœã‚’æŒ¿å…¥ -->
                </div>
            </section>

        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let numberFrequencies = Array(38).fill(0); // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ã€œ37ã‚’ä½¿ç”¨
        let totalDraws = 0;
        
        // ç›´è¿‘ãƒˆãƒ¬ãƒ³ãƒ‰ç”¨
        let recentFrequencies = Array(38).fill(0);
        let recentAvgSum = 0;
        const RECENT_WINDOW = 10; 

        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
        let statsData = {
            avgSum: 0,
            stdDevSum: 0,
            avgFreqSum: 0,
            lastDraw: [],        
            lastOddEven: "",     
            pullProb: {},        
            consecProb: {},      
            oeTransitionProb: {} 
        };

        // DOMè¦ç´ 
        const elements = {
            csvData: document.getElementById('csvData'),
            includeBonus: document.getElementById('includeBonus'),
            btnMockData: document.getElementById('btnMockData'),
            btnAnalyze: document.getElementById('btnAnalyze'),
            analysisSection: document.getElementById('analysisSection'),
            hotNumbers: document.getElementById('hotNumbers'),
            coldNumbers: document.getElementById('coldNumbers'),
            recentHot: document.getElementById('recentHot'),
            recentSum: document.getElementById('recentSum'),
            allTimeSum: document.getElementById('allTimeSum'),
            latestDraw: document.getElementById('latestDraw'),
            simulationSection: document.getElementById('simulationSection'),
            
            // UIåˆ¶å¾¡ç”¨
            modeRadios: document.querySelectorAll('input[name="simMode"]'),
            countModeUI: document.getElementById('countModeUI'),
            allModeUI: document.getElementById('allModeUI'),
            simCount: document.getElementById('simCount'),
            ticketCount: document.getElementById('ticketCount'),
            
            btnSimulate: document.getElementById('btnSimulate'),
            resultSection: document.getElementById('resultSection'),
            predictionResults: document.getElementById('predictionResults'),
            statisticalFeatures: document.getElementById('statisticalFeatures')
        };

        // UIã‚¤ãƒ™ãƒ³ãƒˆ: ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        elements.modeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'count') {
                    elements.countModeUI.classList.remove('hidden');
                    elements.allModeUI.classList.add('hidden');
                } else {
                    elements.countModeUI.classList.add('hidden');
                    elements.allModeUI.classList.remove('hidden');
                }
            });
        });

        function getBallColorClass(num) {
            if (num >= 1 && num <= 9) return 'ball-yellow';
            if (num >= 10 && num <= 19) return 'ball-blue';
            if (num >= 20 && num <= 29) return 'ball-red';
            if (num >= 30 && num <= 37) return 'ball-green';
            return 'bg-gray-500';
        }

        function countConsecutives(nums) {
            let count = 0;
            for(let i = 0; i < nums.length - 1; i++) {
                if(nums[i+1] - nums[i] === 1) count++;
            }
            return count;
        }

        function getOddEvenKey(nums) {
            let odd = nums.filter(n => n % 2 !== 0).length;
            return `${odd}:${7 - odd}`;
        }

        // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        elements.btnMockData.addEventListener('click', () => {
            let csv = [];
            for (let i = 1; i <= 300; i++) {
                let available = Array.from({length: 37}, (_, i) => i + 1);
                let mainDraw = [];
                for (let j = 0; j < 7; j++) {
                    let r = Math.floor(Math.random() * available.length);
                    mainDraw.push(available[r]);
                    available.splice(r, 1);
                }
                mainDraw.sort((a, b) => a - b);
                
                let bonusDraw = [];
                for (let j = 0; j < 2; j++) {
                    let r = Math.floor(Math.random() * available.length);
                    bonusDraw.push(available[r]);
                    available.splice(r, 1);
                }
                csv.push([...mainDraw, ...bonusDraw].join(','));
            }
            elements.csvData.value = csv.join('\n');
            alert('300å›åˆ†ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼\nä¸€ç•ªä¸‹ã®è¡ŒãŒæœ€æ–°å›ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚');
        });

        // è§£æå‡¦ç†
        elements.btnAnalyze.addEventListener('click', () => {
            const rawData = elements.csvData.value.trim();
            const includeBonus = elements.includeBonus.checked;
            
            if (!rawData) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            numberFrequencies = Array(38).fill(0);
            recentFrequencies = Array(38).fill(0);
            totalDraws = 0;
            recentAvgSum = 0;
            
            let sums = [];
            let validDrawsHist = []; 
            let pullCounts = {};
            let consecCounts = {};
            let transitionCounts = {};
            let prevDraw = null;
            let prevOddEven = null;

            const lines = rawData.split('\n');
            lines.forEach(line => {
                const tokens = line.split(/[\s,]+/);
                const numbers = tokens
                    .filter(token => /^\d+$/.test(token))
                    .map(n => parseInt(n, 10))
                    .filter(n => n >= 1 && n <= 37);

                if (numbers.length >= 7) {
                    const maxLen = includeBonus ? Math.min(numbers.length, 9) : 7;
                    for (let i = 0; i < maxLen; i++) {
                        numberFrequencies[numbers[i]]++;
                    }
                    totalDraws++;
                    
                    let mainNums = numbers.slice(0, 7).sort((a, b) => a - b);
                    validDrawsHist.push(mainNums);
                    sums.push(mainNums.reduce((a, b) => a + b, 0));
                    
                    let consec = countConsecutives(mainNums);
                    consecCounts[consec] = (consecCounts[consec] || 0) + 1;
                    
                    let oeKey = getOddEvenKey(mainNums);
                    
                    if (prevDraw !== null) {
                        let pull = mainNums.filter(n => prevDraw.includes(n)).length;
                        pullCounts[pull] = (pullCounts[pull] || 0) + 1;
                        
                        if (!transitionCounts[prevOddEven]) transitionCounts[prevOddEven] = {};
                        transitionCounts[prevOddEven][oeKey] = (transitionCounts[prevOddEven][oeKey] || 0) + 1;
                    }
                    
                    prevDraw = mainNums;
                    prevOddEven = oeKey;
                }
            });

            if (totalDraws < 2) {
                alert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            let recentDraws = validDrawsHist.slice(-RECENT_WINDOW);
            if (recentDraws.length > 0) {
                let recentTotalSum = 0;
                recentDraws.forEach(draw => {
                    recentTotalSum += draw.reduce((a, b) => a + b, 0);
                    draw.forEach(num => { recentFrequencies[num]++; });
                });
                recentAvgSum = recentTotalSum / recentDraws.length;
            }

            statsData.avgSum = sums.reduce((a, b) => a + b, 0) / sums.length;
            statsData.stdDevSum = Math.sqrt(sums.reduce((a, b) => a + Math.pow(b - statsData.avgSum, 2), 0) / sums.length);
            
            let totalFreqSum = 0;
            validDrawsHist.forEach(draw => {
                totalFreqSum += draw.reduce((a, b) => a + numberFrequencies[b], 0);
            });
            statsData.avgFreqSum = totalFreqSum / validDrawsHist.length;

            let totalTransitions = validDrawsHist.length - 1;
            statsData.pullProb = {};
            for(let k in pullCounts) statsData.pullProb[k] = pullCounts[k] / totalTransitions;
            
            statsData.consecProb = {};
            for(let k in consecCounts) statsData.consecProb[k] = consecCounts[k] / validDrawsHist.length;
            
            statsData.oeTransitionProb = {};
            for(let pk in transitionCounts) {
                statsData.oeTransitionProb[pk] = {};
                let sum = Object.values(transitionCounts[pk]).reduce((a,b)=>a+b, 0);
                for(let ck in transitionCounts[pk]) {
                    statsData.oeTransitionProb[pk][ck] = transitionCounts[pk][ck] / sum;
                }
            }

            statsData.lastDraw = prevDraw;
            statsData.lastOddEven = prevOddEven;

            displayAnalysis();
            elements.analysisSection.classList.remove('hidden');
            elements.simulationSection.classList.remove('hidden');
            elements.resultSection.classList.add('hidden');
        });

        function displayAnalysis() {
            elements.latestDraw.innerHTML = '';
            statsData.lastDraw.forEach(num => {
                let colorClass = getBallColorClass(num);
                elements.latestDraw.innerHTML += `<div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm ${colorClass}">${num}</div>`;
            });

            const stats = [];
            for (let i = 1; i <= 37; i++) {
                stats.push({ number: i, count: numberFrequencies[i] });
            }
            stats.sort((a, b) => b.count - a.count);

            elements.hotNumbers.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                elements.hotNumbers.innerHTML += `<li class="flex justify-between border-b border-red-200 py-1"><span>ç¬¬${i+1}ä½: <b>${stats[i].number}</b></span> <span>${stats[i].count}å›</span></li>`;
            }

            elements.coldNumbers.innerHTML = '';
            const coldStats = [...stats].reverse();
            for (let i = 0; i < 5; i++) {
                elements.coldNumbers.innerHTML += `<li class="flex justify-between border-b border-blue-200 py-1"><span>ãƒ¯ãƒ¼ã‚¹ãƒˆ${i+1}ä½: <b>${coldStats[i].number}</b></span> <span>${coldStats[i].count}å›</span></li>`;
            }
            
            let recentStats = [];
            for(let i=1; i<=37; i++) {
                if(recentFrequencies[i] > 0) recentStats.push({number: i, count: recentFrequencies[i]});
            }
            recentStats.sort((a,b) => b.count - a.count);
            
            elements.recentHot.innerHTML = '';
            for(let i=0; i<Math.min(6, recentStats.length); i++) {
                elements.recentHot.innerHTML += `<span class="bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full font-bold shadow-sm border border-yellow-400">${recentStats[i].number}</span>`;
            }
            
            elements.recentSum.textContent = Math.round(recentAvgSum * 10) / 10;
            elements.allTimeSum.textContent = Math.round(statsData.avgSum * 10) / 10;

            let topPull = Object.keys(statsData.pullProb).reduce((a, b) => statsData.pullProb[a] > statsData.pullProb[b] ? a : b);
            let topConsec = Object.keys(statsData.consecProb).reduce((a, b) => statsData.consecProb[a] > statsData.consecProb[b] ? a : b);

            elements.statisticalFeatures.innerHTML = `
                <li><span class="block text-gray-500 text-xs">å¹³å‡åˆè¨ˆå€¤ (Zã‚¹ã‚³ã‚¢åŸºæº–)</span> <b class="text-indigo-600 text-lg">${Math.round(statsData.avgSum * 10) / 10}</b></li>
                <li><span class="block text-gray-500 text-xs">æœ€ã‚‚å¤šã„é€£ç•ªãƒšã‚¢æ•°</span> <b class="text-indigo-600 text-lg">${topConsec} çµ„</b></li>
                <li><span class="block text-gray-500 text-xs">å‰å›ã‹ã‚‰ã®å¹³å‡å¼•ã£å¼µã‚Šæ•°</span> <b class="text-indigo-600 text-lg">${topPull} å€‹</b></li>
                <li class="col-span-1 md:col-span-3 mt-2 pt-2 border-t border-gray-100">
                    <span class="text-gray-500 text-xs mr-2">æœ€æ–°å›ã®å¥‡å¶æ¯” [${statsData.lastOddEven}] ã‹ã‚‰ã®æ¨ç§»äºˆæ¸¬:</span>
                    <span class="text-sm">æ¬¡ã¯ <b>${
                        statsData.oeTransitionProb[statsData.lastOddEven] ? 
                        Object.keys(statsData.oeTransitionProb[statsData.lastOddEven]).reduce((a, b) => statsData.oeTransitionProb[statsData.lastOddEven][a] > statsData.oeTransitionProb[statsData.lastOddEven][b] ? a : b) : 'ä¸æ˜'
                    }</b> ã«ãªã‚‹ç¢ºç‡ãŒæœ€ã‚‚é«˜ã„ã§ã™ã€‚</span>
                </li>
            `;
        }

        // --- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ ---
        elements.btnSimulate.addEventListener('click', () => {
            const mode = document.querySelector('input[name="simMode"]:checked').value;
            const ticketCount = parseInt(elements.ticketCount.value) || 5;
            
            elements.btnSimulate.disabled = true;
            elements.btnSimulate.innerHTML = `<div class="loader border-gray-800 border-top-yellow-200"></div> <span>æº–å‚™ä¸­...</span>`;
            elements.resultSection.classList.add('hidden');

            if (mode === 'count') {
                const iterations = parseInt(elements.simCount.value);
                setTimeout(() => {
                    runMonteCarloCountMode(iterations, ticketCount);
                }, 50);
            } else {
                setTimeout(() => {
                    runAllPatternsMode(ticketCount);
                }, 50);
            }
        });

        function resetSimBtn() {
            elements.btnSimulate.disabled = false;
            elements.btnSimulate.innerHTML = `<span>ğŸ° å®Œå…¨ä¹±æ•°ç”Ÿæˆï¼†å°¤åº¦è©•ä¾¡ã‚’é–‹å§‹ã™ã‚‹</span>`;
            elements.resultSection.classList.remove('hidden');
            elements.resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // ä¹±æ•°ç”Ÿæˆ
        function generateRandom7() {
            let available = Array.from({length: 37}, (_, i) => i + 1);
            let picked = [];
            for(let i = 0; i < 7; i++) {
                let r = Math.floor(Math.random() * available.length);
                picked.push(available[r]);
                available.splice(r, 1);
            }
            return picked.sort((a, b) => a - b);
        }

        // ã‚¹ã‚³ã‚¢è©•ä¾¡ (å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³è§£æã«è€ãˆã†ã‚‹é«˜é€ŸåŒ–ç‰ˆ)
        function evaluateDraw(draw) {
            let score = 10000;
            let sum = 0;
            let oddCount = 0;
            let pullCount = 0;
            let consecCount = 0;
            let freqSum = 0;
            let recentFreqSum = 0;

            for (let i = 0; i < 7; i++) {
                let n = draw[i];
                sum += n;
                if (n % 2 !== 0) oddCount++;
                if (statsData.lastDraw && statsData.lastDraw.includes(n)) pullCount++;
                freqSum += numberFrequencies[n];
                recentFreqSum += recentFrequencies[n];
                if (i < 6 && draw[i+1] - n === 1) consecCount++;
            }

            let zScoreSum = Math.abs((sum - statsData.avgSum) / (statsData.stdDevSum || 1));
            score -= zScoreSum * 600;

            let oeKey = oddCount + ":" + (7 - oddCount);
            let transProb = (statsData.oeTransitionProb[statsData.lastOddEven] && statsData.oeTransitionProb[statsData.lastOddEven][oeKey]) || 0;
            score -= (1 - transProb) * 1500;

            let pullProb = statsData.pullProb[pullCount] || 0;
            score -= (1 - pullProb) * 1200;

            let consecProb = statsData.consecProb[consecCount] || 0;
            score -= (1 - consecProb) * 1000;

            let diffFreq = Math.abs(freqSum - statsData.avgFreqSum);
            score -= diffFreq * 10;

            score += recentFreqSum * 80;

            let zScoreRecent = Math.abs((sum - recentAvgSum) / (statsData.stdDevSum || 1));
            score -= zScoreRecent * 400;

            return { score: score, sum: sum, oddEven: oeKey, pull: pullCount, consec: consecCount };
        }

        // --- ã€æ—§ã€‘å›æ•°æŒ‡å®šãƒ¢ãƒ¼ãƒ‰ ---
        function runMonteCarloCountMode(iterations, ticketCount) {
            let simulationResults = [];
            for (let i = 0; i < iterations; i++) {
                let draw = generateRandom7();
                let evaluation = evaluateDraw(draw);
                simulationResults.push({ draw: draw, score: evaluation.score, details: evaluation });
            }
            
            simulationResults.sort((a, b) => b.score - a.score);

            let uniqueResults = [];
            let seen = new Set();
            for (let item of simulationResults) {
                let key = item.draw.join(',');
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueResults.push(item);
                    if (uniqueResults.length >= ticketCount * 10) break;
                }
            }

            const predictions = pickPredictions(uniqueResults, ticketCount);
            renderResults(predictions, iterations, null);
            resetSimBtn();
        }

        // --- ã€æ–°ã€‘å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨è§£æãƒ¢ãƒ¼ãƒ‰ï¼ˆéåŒæœŸãƒ»ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼‰ ---
        function runAllPatternsMode(ticketCount) {
            const TOTAL_COMBINATIONS = 10295472;
            let processed = 0;
            const CHUNK_SIZE = 50000; // ç”»é¢ã‚’ãƒ•ãƒªãƒ¼ã‚ºã•ã›ãªã„ãŸã‚ã®å‡¦ç†å˜ä½
            
            // çµ„ã¿åˆã‚ã›ç”Ÿæˆç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
            let currentCombo = [1, 2, 3, 4, 5, 6, 7];
            let isDone = false;

            let topResults = [];
            let minTopScore = -Infinity;
            const KEEP_COUNT = ticketCount * 10; // å¾Œã§æ•£ã‚‰ã™ãŸã‚ã«å¤šã‚ã«ä¸Šä½ã‚’ã‚­ãƒ¼ãƒ—

            function processChunk() {
                let chunkCount = 0;
                while (chunkCount < CHUNK_SIZE && !isDone) {
                    let draw = [currentCombo[0], currentCombo[1], currentCombo[2], currentCombo[3], currentCombo[4], currentCombo[5], currentCombo[6]];
                    let evaluation = evaluateDraw(draw);
                    
                    if (evaluation.score > minTopScore) {
                        topResults.push({ draw: draw, score: evaluation.score, details: evaluation });
                        topResults.sort((a, b) => b.score - a.score);
                        if (topResults.length > KEEP_COUNT) {
                            topResults.pop();
                        }
                        if (topResults.length === KEEP_COUNT) {
                            minTopScore = topResults[topResults.length - 1].score;
                        }
                    }

                    // è¾æ›¸é †ã§æ¬¡ã®çµ„ã¿åˆã‚ã›ã‚’ç”Ÿæˆ
                    let i = 6;
                    while (i >= 0 && currentCombo[i] === 37 - 6 + i) {
                        i--;
                    }
                    if (i < 0) {
                        isDone = true;
                    } else {
                        currentCombo[i]++;
                        for (let j = i + 1; j < 7; j++) {
                            currentCombo[j] = currentCombo[j - 1] + 1;
                        }
                    }
                    
                    chunkCount++;
                    processed++;
                }

                if (isDone) {
                    // å®Œäº†
                    const predictions = pickPredictions(topResults, ticketCount);
                    renderResults(predictions, TOTAL_COMBINATIONS, "å…¨1029ä¸‡é€šã‚Š å®Œå…¨è§£æ");
                    resetSimBtn();
                } else {
                    // ç¶™ç¶šä¸­: UIã‚’æ›´æ–°ã—ã¦æ¬¡ã®å‡¦ç†ã‚’äºˆç´„ã™ã‚‹
                    let percent = ((processed / TOTAL_COMBINATIONS) * 100).toFixed(1);
                    elements.btnSimulate.innerHTML = `
                        <div class="loader border-gray-800 border-top-yellow-200"></div> 
                        <div class="flex flex-col items-center">
                            <span class="text-sm font-bold">å…¨10,295,472ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è§£æä¸­... ${percent}%</span>
                            <span class="text-xs text-yellow-800">å‡¦ç†æ¸ˆ: ${processed.toLocaleString()} ä»¶</span>
                        </div>
                    `;
                    setTimeout(processChunk, 0); // éåŒæœŸã§å‘¼ã³å‡ºã—ã€ç”»é¢ã®å†æç”»ã‚’æŒŸã‚€
                }
            }
            
            // åˆå›å®Ÿè¡Œ
            processChunk();
        }

        // çµæœã‹ã‚‰è¡¨ç¤ºç”¨ã®å£æ•°ã‚’æŠ½å‡ºï¼ˆ1å£ç›®ã¯æœ€é«˜å¾—ç‚¹ã€æ®‹ã‚Šã¯åˆ†æ•£ï¼‰
        function pickPredictions(uniqueResults, ticketCount) {
            const predictions = [];
            if (uniqueResults.length > 0) {
                predictions.push(uniqueResults[0]);
                let candidates = uniqueResults.slice(1);
                for (let i = candidates.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
                }
                for (let i = 0; i < ticketCount - 1 && i < candidates.length; i++) {
                    predictions.push(candidates[i]);
                }
            }
            return predictions;
        }

        // çµæœã®æç”»
        function renderResults(predictions, iterations, modeText) {
            let introText = "";
            if (modeText) {
                // ç›®æ¨™ã‚¹ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ‰ã®æ–‡è¨€
                introText = `
                    <div class="text-center text-sm text-gray-800 mb-6 bg-yellow-100 p-5 rounded-lg border-2 border-yellow-400 shadow-sm">
                        <b class="text-yellow-700 text-lg block mb-2">ğŸ”¥ ${modeText} å®Œäº† ğŸ”¥</b>
                        ãƒ­ãƒˆ7ã®å…¨çµ„ã¿åˆã‚ã› <b>${iterations.toLocaleString()} é€šã‚Š</b> å…¨ã¦ã‚’è¨ˆç®—æ©Ÿã§ç·å½“ãŸã‚Šè©•ä¾¡ã—ã€<br>
                        çµ±è¨ˆå­¦çš„ã«æœ€ã‚‚å°¤åº¦ï¼ˆç¢ºã‹ã‚‰ã—ã•ï¼‰ã®é«˜ã„ã€æœ€å¼·ã® <b>${predictions.length} ãƒ‘ã‚¿ãƒ¼ãƒ³</b>ã‚’æŠ½å‡ºã—ã¾ã—ãŸï¼
                    </div>
                `;
            } else {
                // å›æ•°æŒ‡å®šãƒ¢ãƒ¼ãƒ‰ã®æ–‡è¨€
                introText = `
                    <div class="text-center text-sm text-gray-600 mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        å®Œå…¨ä¹±æ•°ã«ã‚ˆã‚‹ä»®æƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’ <b>${iterations.toLocaleString()} å›</b> å®Ÿè¡Œã—ã¾ã—ãŸã€‚<br>
                        ç”Ÿæˆã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã†ã¡ã€æœ€æ–°å›ã‹ã‚‰ã®<b class="text-indigo-700">ã€Œå¥‡å¶ã®æ¨ç§»ç¢ºç‡ã€ã€Œå¼•ã£å¼µã‚Šç¢ºç‡ã€ã€Œé€£ç•ªç¢ºç‡ã€</b>ãªã©ã®çµ±è¨ˆæ¡ä»¶ã‚’<br>
                        æœ€ã‚‚é«˜ãæº€ãŸã—ãŸä¸Šä½ ${predictions.length} ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å³é¸è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
                    </div>
                `;
            }

            elements.predictionResults.innerHTML = introText;

            predictions.forEach((item, index) => {
                const draw = item.draw;
                const details = item.details;
                
                let html = `
                    <div class="bg-white p-4 rounded-xl shadow-md border ${index === 0 && !modeText ? 'border-yellow-400 bg-yellow-50/30' : 'border-gray-200'} flex flex-col items-center gap-3 relative overflow-hidden">
                        ${index === 0 && !modeText ? '<div class="absolute top-0 left-0 bg-yellow-400 text-xs font-bold px-2 py-1 rounded-br-lg">æœ¬å‘½äºˆæƒ³</div>' : ''}
                        
                        <div class="w-full flex justify-between items-center border-b pb-2 mb-1 mt-2">
                            <span class="font-bold text-gray-700 bg-gray-100 px-3 py-1 rounded-full text-sm">äºˆæƒ³ ${index + 1}</span>
                            <span class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded border font-bold ${details.score >= 9500 ? 'text-red-600 border-red-200 bg-red-50' : ''}">é©åˆã‚¹ã‚³ã‚¢: ${Math.round(details.score)}</span>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-center py-2">
                `;
                
                draw.forEach(num => {
                    const colorClass = getBallColorClass(num);
                    html += `<div class="loto-ball ${colorClass} hover:scale-110 transition-transform cursor-default">${num}</div>`;
                });

                html += `
                        </div>
                        <div class="w-full grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-gray-600 mt-2 bg-gray-50 p-3 rounded border border-gray-100">
                            <div class="flex flex-col"><span class="text-gray-400">å‰å›ã‹ã‚‰ã®å¼•ã£å¼µã‚Š</span><b class="${details.pull > 0 ? 'text-blue-600' : ''}">${details.pull} å€‹</b></div>
                            <div class="flex flex-col"><span class="text-gray-400">é€£ç•ªãƒšã‚¢æ•°</span><b class="${details.consec > 0 ? 'text-green-600' : ''}">${details.consec} çµ„</b></div>
                            <div class="flex flex-col"><span class="text-gray-400">å¥‡å¶æ¯” (å¥‡:å¶)</span><b>${details.oddEven}</b></div>
                            <div class="flex flex-col"><span class="text-gray-400">åˆè¨ˆå€¤</span><b>${details.sum}</b></div>
                        </div>
                    </div>
                `;
                elements.predictionResults.innerHTML += html;
            });
        }
    </script>
</body>
</html>
